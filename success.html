<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Atelier Vele√©</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/" class="brand-link">Atelier Vele√©</a>
            </div>
        </div>
    </nav>

    <main class="success-main">
        <div class="success-container">
            <div class="success-content">
                <div class="success-icon">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="#4CAF50"/>
                        <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                
                <h1>Payment Successful!</h1>
                <p>Thank you for your order. You will receive a confirmation email shortly.</p>
                <div id="orderDetails" style="display: none;">
                    <p><strong>Order ID:</strong> <span id="orderId"></span></p>
                </div>
                
                <div class="success-actions">
                    <a href="/" class="btn-primary">Continue Shopping</a>
                    <a href="/thank-you.html" class="btn-secondary">View Order Details</a>
                </div>
            </div>
        </div>
    </main>

    <footer-placeholder></footer-placeholder>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    <script src="cart.js"></script>
    <script>
        // Set current year in footer and clear cart
        document.addEventListener('DOMContentLoaded', async () => {
            await loadComponent('footer.html', 'footer-placeholder');
            const currentYear = new Date().getFullYear();
            const yearElement = document.getElementById('currentYear');
            if (yearElement) {
                yearElement.textContent = currentYear;
            }
            
            // Clear the cart since payment was successful
            if (window.CartManager) {
                const cartManager = new CartManager();
                cartManager.clearCart();
            }
            
            // Also clear any localStorage cart data directly as backup
            localStorage.removeItem('cart');
            localStorage.removeItem('pendingOrder');
            
            // Clear form data since order is complete
            localStorage.removeItem('pendingFormData');
            console.log('üßπ Cleared form data after successful payment');
            
            // Show order details if session_id is present
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            if (sessionId) {
                const orderDetailsDiv = document.getElementById('orderDetails');
                const orderIdSpan = document.getElementById('orderId');
                if (orderDetailsDiv && orderIdSpan) {
                    orderIdSpan.textContent = sessionId;
                    orderDetailsDiv.style.display = 'block';
                }
                
                // Update order status in Firebase
                await updateOrderStatus(sessionId);
            }
        });

        // Function to update order status after successful payment
        async function updateOrderStatus(stripeSessionId) {
            try {
                console.log('üîÑ Updating order status for Stripe session:', stripeSessionId);
                
                // Wait for Firebase to be ready
                if (!window.firebase || !window.firebase.firestore) {
                    console.warn('Firebase not ready, skipping order status update');
                    return;
                }

                const db = firebase.firestore();
                
                console.log('üîç Searching for order with session ID:', stripeSessionId);
                
                // First, try to find any order with this session ID (without status filter)
                const allOrdersQuery = db.collection('orders')
                    .where('stripeSessionId', '==', stripeSessionId)
                    .limit(5);

                console.log('üîç Searching all orders with session ID...');
                const allOrdersSnapshot = await allOrdersQuery.get();
                
                console.log('üìä Found orders with session ID:', {
                    count: allOrdersSnapshot.size,
                    orders: allOrdersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        data: {
                            orderNumber: doc.data().orderNumber,
                            status: doc.data().status,
                            paymentStatus: doc.data().paymentStatus,
                            stripeSessionId: doc.data().stripeSessionId
                        }
                    }))
                });
                
                // Find the order with the matching Stripe session ID and pending payment status
                const ordersQuery = db.collection('orders')
                    .where('stripeSessionId', '==', stripeSessionId)
                    .where('status', '==', 'pending_payment')
                    .limit(1);

                console.log('üîç Searching for pending orders with session ID...');
                const querySnapshot = await ordersQuery.get();

                if (!querySnapshot.empty) {
                    const orderDoc = querySnapshot.docs[0];
                    const orderId = orderDoc.id;
                    const orderData = orderDoc.data();
                    
                    console.log('üìã Found pending order to update:', {
                        orderId: orderId,
                        orderNumber: orderData.orderNumber,
                        currentStatus: orderData.status,
                        currentPaymentStatus: orderData.paymentStatus
                    });

                    // Update order status and payment status
                    await db.collection('orders').doc(orderId).update({
                        status: 'payment_success',
                        paymentStatus: 'paid',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        paidAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log('‚úÖ Order status updated successfully:', {
                        orderId: orderId,
                        newStatus: 'payment_success',
                        newPaymentStatus: 'paid'
                    });

                    // Update the displayed order ID to show the actual order number instead of session ID
                    const orderIdSpan = document.getElementById('orderId');
                    if (orderIdSpan && orderData.orderNumber) {
                        orderIdSpan.textContent = `#${orderData.orderNumber}`;
                    }
                } else {
                    console.warn('‚ö†Ô∏è No pending order found for Stripe session:', stripeSessionId);
                    
                    // Fallback: Try to update any order with this session ID (even if not pending)
                    if (!allOrdersSnapshot.empty) {
                        console.log('üîÑ Fallback: Updating any order with this session ID...');
                        const orderDoc = allOrdersSnapshot.docs[0];
                        const orderId = orderDoc.id;
                        const orderData = orderDoc.data();
                        
                        console.log('üìã Found order for fallback update:', {
                            orderId: orderId,
                            orderNumber: orderData.orderNumber,
                            currentStatus: orderData.status,
                            currentPaymentStatus: orderData.paymentStatus
                        });

                        // Only update if not already paid
                        if (orderData.paymentStatus !== 'paid') {
                            await db.collection('orders').doc(orderId).update({
                                status: 'payment_success',
                                paymentStatus: 'paid',
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                paidAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            console.log('‚úÖ Fallback order status updated successfully');
                            
                            // Update the displayed order ID
                            const orderIdSpan = document.getElementById('orderId');
                            if (orderIdSpan && orderData.orderNumber) {
                                orderIdSpan.textContent = `#${orderData.orderNumber}`;
                            }
                        } else {
                            console.log('‚ÑπÔ∏è Order already marked as paid, no update needed');
                        }
                    } else {
                        console.error('‚ùå No order found with session ID:', stripeSessionId);
                    }
                }

            } catch (error) {
                console.error('‚ùå Error updating order status:', error);
                // Don't throw the error - we don't want to break the success page
                // if the status update fails, the payment was still successful
            }
        }
    </script>
</body>
</html> 