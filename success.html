<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Atelier VeleÃ©</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/" class="brand-link">Atelier VeleÃ©</a>
            </div>
        </div>
    </nav>

    <main class="success-main">
        <div class="success-container">
            <div class="success-content">
                <div class="success-icon">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="#4CAF50"/>
                        <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                
                <h1>Payment Successful!</h1>
                <p>Thank you for your order. You will receive a confirmation email shortly.</p>
                <div id="orderDetails" style="display: none;">
                    <p><strong>Order ID:</strong> <span id="orderId"></span></p>
                </div>
                
                <div class="success-actions">
                    <a href="/" class="btn-primary">Continue Shopping</a>
                    <a href="/profile.html" class="btn-secondary">View Order Details</a>
                </div>
            </div>
        </div>
    </main>

    <footer-placeholder></footer-placeholder>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="constants.js"></script>
    <script src="firebase-config.js"></script>
    <script src="cart.js"></script>
    <script>
        // ---- Firebase Initialization
        let app, auth, db;

        function initFirebase() {
            if (!window.firebase || !window.firebase.firestore || !window.firebase.auth) {
                console.warn('Firebase not ready, skipping initialization');
                return false;
            }
            
            app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
            
            // Set persistence for auth state across page reloads
            return auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    console.log('âœ… Firebase auth persistence set to LOCAL');
                    return true;
                })
                .catch(error => {
                    console.warn('âš ï¸ Could not set auth persistence:', error);
                    return true; // Continue anyway
                });
        }

        // ---- Component Loading Helper
        async function loadComponent(url, containerId) {
            try {
                const response = await fetch(url);
                const html = await response.text();
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = html;
                } else {
                    const placeholder = document.querySelector(containerId);
                    if (placeholder) {
                        placeholder.innerHTML = html;
                    }
                }
            } catch (error) {
                console.warn(`Failed to load component from ${url}:`, error);
            }
        }

        // ---- Cart Management
        function clearCartData() {
            console.log('ðŸ§¹ Clearing cart data after successful payment...');
            
            // Clear all cart and checkout related data from localStorage using constants
            localStorage.removeItem(STORAGE_CONSTANTS.cartKey);
            localStorage.removeItem(STORAGE_CONSTANTS.pendingOrderKey);
            localStorage.removeItem(STORAGE_CONSTANTS.pendingFormDataKey);
            localStorage.removeItem(STORAGE_CONSTANTS.pendingCheckoutKey);
            localStorage.removeItem(STORAGE_CONSTANTS.stripeSessionIdKey);
            localStorage.removeItem(STORAGE_CONSTANTS.checkoutSessionIdKey);
            
            console.log('âœ… Cart and checkout data cleared from localStorage');
            
            // Also clear the cart icon count if it exists
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
                cartCount.textContent = '0';
                cartCount.style.display = 'none';
                console.log('ðŸ”„ Updated cart count display');
            }
        }

        // ---- Order Status Update
        async function updateOrderStatusInFirebase(stripeSessionId, user) {
            if (!stripeSessionId || !user) {
                console.warn('âš ï¸ Missing session ID or user for order update');
                return;
            }

            console.log('ðŸ”„ Updating order status for session:', stripeSessionId);
            console.log('ðŸ‘¤ User details:', {
                uid: user.uid,
                email: user.email || 'No email',
                isAnonymous: user.isAnonymous,
                displayName: user.displayName || 'No display name'
            });

            try {
                // Query for orders with matching session ID and belonging to this user
                const ordersQuery = db.collection('orders')
                    .where('stripeSessionId', '==', stripeSessionId)
                    .where('customerId', '==', user.uid)
                    .limit(1);

                const querySnapshot = await ordersQuery.get();

                if (querySnapshot.empty) {
                    console.warn('âš ï¸ No order found for session:', stripeSessionId);
                    return;
                }

                const orderDoc = querySnapshot.docs[0];
                const orderData = orderDoc.data();
                const orderId = orderDoc.id;

                console.log('ðŸ“‹ Found order to update:', {
                    orderId: orderId,
                    orderNumber: orderData.orderNumber,
                    currentStatus: orderData.status,
                    currentPaymentStatus: orderData.paymentStatus
                });

                // Only update if not already paid
                if (orderData.paymentStatus !== 'paid') {
                    await db.collection('orders').doc(orderId).update({
                        status: 'payment_success',
                        paymentStatus: 'paid',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        paidAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('âœ… Order status updated successfully to payment_success/paid');
                } else {
                    console.log('â„¹ï¸ Order already marked as paid, skipping update');
                }

                // Update displayed order ID with actual order number
                updateOrderDisplay(orderData.orderNumber);

            } catch (error) {
                console.error('âŒ Error updating order status:', error);
                // Don't throw - we don't want to break the success page
            }
        }

        // ---- UI Updates
        function updateOrderDisplay(orderNumber) {
            const orderIdSpan = document.getElementById('orderId');
            if (orderIdSpan && orderNumber) {
                orderIdSpan.textContent = `#${orderNumber}`;
            }
        }

        function setupOrderDisplay(sessionId) {
            if (!sessionId) {
                const orderIdElement = document.getElementById('orderId');
                if (orderIdElement) {
                    orderIdElement.textContent = 'N/A';
                }
                console.warn('No Stripe session ID found in URL.');
                return;
            }

            // Show order details
            const orderDetailsDiv = document.getElementById('orderDetails');
            const orderIdSpan = document.getElementById('orderId');
            if (orderDetailsDiv && orderIdSpan) {
                orderIdSpan.textContent = sessionId; // Will be updated later with order number
                orderDetailsDiv.style.display = 'block';
            }
        }

        // ---- Authentication & Order Processing
        async function processSuccessPage() {
            console.log('ðŸš€ Processing success page...');

            // Initialize Firebase
            const firebaseReady = await initFirebase();
            if (!firebaseReady) {
                console.error('âŒ Firebase initialization failed');
                return;
            }

            // Get session ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            // Set up initial display
            setupOrderDisplay(sessionId);
            
            if (!sessionId) {
                console.warn('âš ï¸ No session ID found, skipping order update');
                return;
            }

            // Use one-shot auth listener pattern to prevent loops
            const unsubscribe = auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    console.log('ðŸ” No user found, signing in anonymously...');
                    try {
                        await auth.signInAnonymously();
                        return; // Wait for the auth state change
                    } catch (error) {
                        console.error('âŒ Failed to sign in anonymously:', error);
                        unsubscribe();
                        return;
                    }
                }

                try {
                    // Process the order update
                    await updateOrderStatusInFirebase(sessionId, user);
                    
                    // Sign out anonymous user after successful processing
                    if (user.isAnonymous) {
                        console.log('ðŸšª Signing out anonymous user after successful processing');
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('âŒ Error during order processing:', error);
                } finally {
                    // Always unsubscribe to prevent loops
                    unsubscribe();
                    console.log('ðŸ”„ Auth listener unsubscribed');
                }
            });

            // Trigger auth check if user already exists
            if (auth.currentUser) {
                console.log('ðŸ” User already authenticated, triggering state change');
            }
        }

        // ---- Page Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ“„ Success page loaded');

            // Load footer component
            await loadComponent('footer.html', 'footer-placeholder');
            
            // Set current year
            const currentYear = new Date().getFullYear();
            const yearElement = document.getElementById('currentYear');
            if (yearElement) {
                yearElement.textContent = currentYear;
            }

            // Process success page logic first (includes Firebase init)
            await processSuccessPage();
            
            // Clear cart data after Firebase is ready
            clearCartData();
        });
    </script>
</body>
</html> 