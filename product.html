<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product • Atelier Veleé</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=5">
    <style>
        body.pd-page { background: #fff; }
        /* Page-scoped swatch styles */
        .swatches-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .swatch-btn { width: 36px; height: 36px; border: 1px solid var(--soft-beige, #e7e1db); border-radius: 6px; background: #fff; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: transform 0.15s ease, border-color 0.15s ease, opacity 0.15s ease; }
        .swatch-btn:hover { transform: translateY(-1px); }
        .swatch-btn.selected { outline: 2px solid var(--charcoal, #2b2b2b); outline-offset: 2px; }
        .swatch-btn[disabled] { cursor: not-allowed; opacity: 0.45; filter: grayscale(0.3); }
        .color-swatch { border-radius: 6px; overflow: hidden; padding: 0; }
        .color-swatch .dot { width: 100%; height: 100%; border-radius: 4px; }
        .size-swatch { font-family: 'Inter', system-ui; font-weight: 600; color: var(--charcoal, #2b2b2b); background: #fff; }
        .swatch-label { font-size: 0.9rem; color: var(--deep-taupe, #756d6a); margin-bottom: 0.25rem; }
        /* Add-to-cart disabled state */
        #addToCartBtn[disabled] { background: #e0e0e0 !important; color: #8c8c8c !important; cursor: not-allowed; opacity: 0.85; }
        #addToCartBtn:not([disabled]):hover { background: var(--deep-taupe); }
        /* Thumbnail grid */
        .pd-thumb-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.75rem; }
        @media (min-width: 1024px) { .pd-thumb-grid { grid-template-columns: repeat(6, 1fr); } }
        .pd-thumb { position: relative; width: 100%; aspect-ratio: 3/4; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .pd-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.2s ease, filter 0.2s ease, opacity 0.2s ease; }
        .pd-thumb:hover img { transform: scale(1.02); }
        .pd-thumb.selected img { filter: grayscale(1); opacity: 0.65; }
        /* Breadcrumb */
        .pd-breadcrumb { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto; font-size: 0.875rem; color: #6b7280; display: flex; gap: 0.5rem; align-items: center; margin: 0 0 1rem 0; }
        .pd-breadcrumb a { color: #6b7280; text-decoration: none; }
        .pd-breadcrumb a:hover { text-decoration: underline; }
        .pd-breadcrumb span { color: #9ca3af; }
        @media (max-width: 767px) { .pd-grid { grid-template-columns: 1fr !important; gap: 1.25rem !important; } #productDescription + div { max-width: none !important; width: 100%; } #addToCartBtn { width: 100%; } }
    </style>
</head>
<body class="pd-page">
    <!-- Shared Header Placeholder -->
    <header-placeholder></header-placeholder>

    <!-- Product Detail Content -->
    <main style="max-width: 1200px; margin: 0 auto; padding: 6rem 2rem 3rem;">

        <div class="pd-grid" style="display: grid; grid-template-columns: 3fr 1fr; gap: 3rem; align-items: start;">
            <div>
                <div style="width: 100%; aspect-ratio: 3/4; background: var(--light-grey, #f5f5f5); border-radius: 12px; overflow: hidden;">
                    <img id="pdMainImage" src="" alt="" style="width: 100%; height: 100%; object-fit: cover; transition: opacity 250ms ease; opacity: 1;">
                </div>
                <div id="pdThumbGrid" class="pd-thumb-grid"></div>
            </div>
            <div>
                <nav class="pd-breadcrumb" aria-label="Breadcrumb">
                    <a href="index.html">Home</a>
                    <span>/</span>
                    <a href="store.html">Store</a>
                    <span>/</span>
                    <span id="pdBreadcrumbCategory">Category</span>
                </nav>
                <h1 id="productName" style="font-family: 'Playfair Display', serif; font-size: 2.25rem; color: var(--charcoal, #2b2b2b); margin: 0 0 0.5rem 0;">Loading…</h1>
                <div id="productPrice" style="font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto; font-size: 1.25rem; color: var(--charcoal, #2b2b2b); margin-bottom: 1.25rem;">—</div>

                <div id="productDescription" style="font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto; font-size: 0.95rem; line-height: 1.7; color: #4b5563; margin: 0 0 1.25rem 0; display: none;"></div>

                <div style="display: grid; gap: 1rem; max-width: 420px;">
                    <div style="display: grid; gap: 0.25rem;">
                        <span class="swatch-label">Available colors</span>
                        <div id="colorSwatches" class="swatches-row"></div>
                    </div>

                    <div style="display: grid; gap: 0.25rem;">
                        <span class="swatch-label">Available sizes</span>
                        <div id="sizeSwatches" class="swatches-row"></div>
                    </div>

                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <button id="addToCartBtn" style="flex: 1; padding: 0.9rem 1.1rem; border: none; border-radius: 10px; background: var(--charcoal, #2b2b2b); color: #fff; font-weight: 600; cursor: pointer; transition: var(--smooth);">Add to cart</button>
                    </div>
                </div>

                <div id="sizeChartContainer" style="margin-top:2rem; display:none;">
                    <button id="sizeChartHeader" type="button" aria-expanded="false" style="width:100%; display:flex; align-items:center; justify-content:space-between; gap:0.75rem; padding:0.75rem 1rem; border:1px solid var(--soft-beige); background:#fff; border-radius:10px; cursor:pointer;">
                        <span style="font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--charcoal);">Size chart (cm)</span>
                        <span aria-hidden="true" id="sizeChartChevron" style="display:inline-flex; transition: transform .2s ease;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </button>
                    <div id="sizeChartContent" style="max-height:0; overflow:hidden; transition:max-height .25s ease, opacity .25s ease; opacity:0;">
                        <div id="sizeChartTableWrap" style="overflow-x:auto; margin-top:0.75rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Shared Footer Placeholder -->
    <footer-placeholder></footer-placeholder>

    <!-- Script Loader (injects script.js, cart.js, etc.) -->
    <script src="main.js"></script>
    <script>
        // Simple helpers (scoped to this page)
        function pdFormatPrice(price, currency = 'EUR') {
            if (typeof price !== 'number') return '—';
            const euros = Math.floor(price / 100);
            const cents = price % 100;
            if (currency === 'EUR') return `€${euros}.${cents.toString().padStart(2, '0')}`;
            return `${currency} ${euros}.${cents.toString().padStart(2, '0')}`;
        }
        function pdImageUrl(name) {
            if (!name) return '';
            if (name.startsWith('http')) return name;
            return `assets/images/${name}`;
        }
        function unique(list) { return Array.from(new Set(list)); }
                    function colorNameToCss(name) {
                if (!name) return '#ccc';
                const map = (window.PRODUCT_CONSTANTS && window.PRODUCT_CONSTANTS.colorHexMap) || window.PRODUCT_COLOR_HEX_MAP || {};
                const key = String(name).toLowerCase();
                return map[key] || name;
            }

        // In-memory page state
        window.pdState = { product: null, variants: [], selectedVariant: null, selectedColor: null, selectedSize: null, selectedImageIndex: 0 };

        document.addEventListener('allScriptsLoaded', async () => {
            const catEl = document.getElementById('pdBreadcrumbCategory');
            const setCategory = (c) => { if (catEl) catEl.textContent = c || 'Product'; };
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            const slugParam = params.get('slug');
            const skuParam = params.get('sku');

            const nameEl = document.getElementById('productName');
            const priceEl = document.getElementById('productPrice');
            const descEl = document.getElementById('productDescription');
            const imgEl = document.getElementById('pdMainImage');
            const colorRow = document.getElementById('colorSwatches');
            const sizeRow = document.getElementById('sizeSwatches');
            const thumbGrid = document.getElementById('pdThumbGrid');
            const addBtn = document.getElementById('addToCartBtn');
            if (addBtn) { addBtn.disabled = true; addBtn.textContent = 'Sold out'; }

            const setName = (n) => { if (nameEl) nameEl.textContent = n || 'Product'; };
            const setPrice = (p, c) => { if (priceEl) priceEl.textContent = pdFormatPrice((p ?? 0), c || 'EUR'); };
            const setDesc = (d) => { if (descEl) { if (d) { descEl.textContent = d; descEl.style.display = ''; } else { descEl.style.display = 'none'; } } };
            const setImage = (src, alt) => { if (imgEl) { imgEl.style.opacity = '1'; imgEl.src = src || ''; imgEl.alt = alt || ''; } };
            function crossfadeMainImage(newIdx, product) {
                if (!imgEl || !product?.images) return;
                const nextSrc = pdImageUrl(product.images[newIdx]);
                const nextAlt = product?.name || '';
                const tempImg = new Image();
                tempImg.onload = () => {
                    // Start fade-out only after next image is ready
                    imgEl.style.transition = 'opacity 250ms ease';
                    // Force a reflow to ensure the transition is recognized
                    void imgEl.offsetWidth;
                    imgEl.style.opacity = '0';
                    const onEnd = (ev) => {
                        if (ev.propertyName !== 'opacity') return;
                        imgEl.removeEventListener('transitionend', onEnd);
                        // Swap image, then fade back in on the next frame
                        imgEl.src = nextSrc;
                        imgEl.alt = nextAlt;
                        requestAnimationFrame(() => {
                            imgEl.style.opacity = '1';
                        });
                    };
                    imgEl.addEventListener('transitionend', onEnd, { once: true });
                };
                tempImg.src = nextSrc;
            }
            function renderThumbGrid(product) {
                if (!thumbGrid) return;
                const images = Array.isArray(product?.images) ? product.images : [];
                if (images.length === 0) { thumbGrid.innerHTML = ''; return; }
                const selectedIdx = Number.isInteger(window.pdState.selectedImageIndex) ? window.pdState.selectedImageIndex : 0;
                thumbGrid.innerHTML = images.map((img, idx) => {
                    const url = pdImageUrl(img);
                    const sel = idx === selectedIdx ? ' selected' : '';
                    return `<div class="pd-thumb${sel}" data-idx="${idx}" title="Preview ${idx+1}"><img src="${url}" alt="Thumbnail ${idx+1}"></div>`;
                }).join('');
            }
            function wireThumbEvents(product) {
                if (!thumbGrid) return;
                thumbGrid.addEventListener('click', (e) => {
                    const cell = e.target.closest('[data-idx]');
                    if (!cell) return;
                    const idx = parseInt(cell.getAttribute('data-idx'), 10);
                    const images = Array.isArray(product?.images) ? product.images : [];
                    if (idx < 0 || idx >= images.length) return;
                    const prevIdx = window.pdState.selectedImageIndex || 0;
                    window.pdState.selectedImageIndex = idx;
                    renderThumbGrid(product);
                    crossfadeMainImage(idx, product);
                });
            }

            function applyVariant(variant) {
                if (!variant) return;
                window.pdState.selectedVariant = variant;
                const priceVal = (typeof variant.price === 'number') ? variant.price : (typeof variant.unitPrice === 'number' ? variant.unitPrice : 0);
                setPrice(priceVal, variant.currency);
            }

            function hasStock(variant) { return (variant && typeof variant.quantity === 'number') ? variant.quantity > 0 : true; }
            function sizesInOrder(sizes) {
                const order = ['XS','S','M','L','XL','XXL'];
                return [...sizes].sort((a,b) => order.indexOf(a) - order.indexOf(b));
            }
            function availableColors(product, sizeFilter = null) {
                const list = (product.variants || []).filter(v => (!sizeFilter || v.size === sizeFilter) && hasStock(v)).map(v => v.color).filter(Boolean);
                return unique(list);
            }
            function availableSizes(product, colorFilter = null) {
                const list = (product.variants || []).filter(v => (!colorFilter || v.color === colorFilter) && hasStock(v)).map(v => v.size).filter(Boolean);
                return sizesInOrder(unique(list));
            }
            function findVariant(product, size, color) {
                if (!product?.variants) return null;
                const variants = product.variants;
                return variants.find(v => v.size === size && v.color === color && hasStock(v)) ||
                       variants.find(v => v.size === size && hasStock(v)) ||
                       variants.find(v => v.color === color && hasStock(v)) ||
                       variants.find(v => hasStock(v)) || null;
            }
            // Toggle add-to-cart availability based on sizes and selected variant
            function updateAddButtonState(product) {
                if (!addBtn) return;
                const colorFilter = window.pdState.selectedColor || null;
                const sizes = availableSizes(product, colorFilter);
                const sizeAvailable = sizes.length > 0;
                const variant = window.pdState.selectedVariant;
                const canAdd = sizeAvailable && !!variant && hasStock(variant);
                addBtn.disabled = !canAdd;
                if (addBtn.disabled) { addBtn.textContent = 'Sold out'; } else { addBtn.textContent = 'Add to cart'; }
            }
            function renderColorSwatches(product) {
                if (!colorRow) return;
                const sizeFilter = window.pdState.selectedSize || null;
                const colors = availableColors(product, sizeFilter);
                const current = window.pdState.selectedColor;
                const allColors = unique((product.variants || []).map(v => v.color).filter(Boolean));
                colorRow.innerHTML = allColors.map(c => {
                    const enabled = colors.includes(c);
                    const selected = current === c;
                    const bg = colorNameToCss(c);
                    return `<button class="swatch-btn color-swatch${selected ? ' selected' : ''}" data-color="${c}" title="${c}" aria-label="Color ${c}"><span class="dot" style="background:${bg};"></span></button>`;
                }).join('');
            }
            function renderSizeSwatches(product) {
                if (!sizeRow) return;
                const colorFilter = window.pdState.selectedColor || null;
                const sizesEnabled = availableSizes(product, colorFilter);
                const allSizes = sizesInOrder(unique((product.variants || []).map(v => v.size).filter(Boolean)));
                const current = window.pdState.selectedSize;
                sizeRow.innerHTML = allSizes.map(s => {
                    const enabled = sizesEnabled.includes(s);
                    const selected = current === s;
                    return `<button class="swatch-btn size-swatch${selected ? ' selected' : ''}" data-size="${s}" ${enabled ? '' : 'disabled'} aria-label="Size ${s}">${s}</button>`;
                }).join('');
            }
            function selectColor(product, color) {
                window.pdState.selectedColor = color;
                // Update sizes based on color
                const sizes = availableSizes(product, color);
                if (!sizes.includes(window.pdState.selectedSize)) {
                    window.pdState.selectedSize = sizes.length > 0 ? sizes[0] : null;
                }
                // Pick best variant (only if a size exists)
                const v = window.pdState.selectedSize ? findVariant(product, window.pdState.selectedSize, window.pdState.selectedColor) : null;
                applyVariant(v);
                renderColorSwatches(product);
                renderSizeSwatches(product);
                updateAddButtonState(product);
                if (addBtn) { addBtn.textContent = addBtn.disabled ? 'Sold out' : 'Add to cart'; }
            }
            function selectSize(product, size) {
                window.pdState.selectedSize = size;
                // Update colors based on size
                const colors = availableColors(product, size);
                if (window.pdState.selectedColor && !colors.includes(window.pdState.selectedColor)) {
                    window.pdState.selectedColor = colors[0] || null;
                }
                const v = window.pdState.selectedSize ? findVariant(product, window.pdState.selectedSize, window.pdState.selectedColor) : null;
                applyVariant(v);
                renderColorSwatches(product);
                renderSizeSwatches(product);
                updateAddButtonState(product);
                if (addBtn) { addBtn.textContent = addBtn.disabled ? 'Sold out' : 'Add to cart'; }
            }
            function wireSwatchEvents(product) {
                if (colorRow) {
                    colorRow.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-color]');
                        if (!btn || btn.disabled) return;
                        selectColor(product, btn.getAttribute('data-color'));
                    });
                }
                if (sizeRow) {
                    sizeRow.addEventListener('click', (e) => {
                        const btn = e.target.closest('[data-size]');
                        if (!btn || btn.disabled) return;
                        selectSize(product, btn.getAttribute('data-size'));
                    });
                }
            }

            function renderSizeChart(product) {
                const root = document.getElementById('sizeChartContainer');
                const wrap = document.getElementById('sizeChartTableWrap');
                const content = document.getElementById('sizeChartContent');
                const header = document.getElementById('sizeChartHeader');
                const chevron = document.getElementById('sizeChartChevron');
                if (!root || !wrap) return;
                const chart = product?.sizeChart;
                const sizes = Array.isArray(chart?.sizes) && chart.sizes.length ? chart.sizes : null;
                const rows = Array.isArray(chart?.rows) ? chart.rows.filter(r => r && (r.label || (r.values && Object.keys(r.values).length))) : [];
                if (!sizes || rows.length === 0) { root.style.display = 'none'; wrap.innerHTML = ''; return; }

                const ths = ['Area', ...sizes].map(h => `<th style="text-align:left; padding:0.5rem 0.75rem; border-bottom:1px solid var(--soft-beige); white-space:nowrap;">${h}</th>`).join('');
                const trs = rows.map(r => {
                    const cells = sizes.map(sz => {
                        const v = r.values?.[sz];
                        return `<td style="padding:0.5rem 0.75rem; border-bottom:1px solid var(--soft-beige);">${(v ?? '')}</td>`;
                    }).join('');
                    return `<tr><td style="padding:0.5rem 0.75rem; border-bottom:1px solid var(--soft-beige); font-weight:600;">${r.label || ''}</td>${cells}</tr>`;
                }).join('');
                wrap.innerHTML = `<table style="border-collapse:collapse; width:100%; background:#fff; border:1px solid var(--soft-beige); border-radius:8px; overflow:hidden;"><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
                root.style.display = '';

                // collapsed by default
                if (content && header && chevron) {
                    content.style.maxHeight = '0px';
                    content.style.opacity = '0';
                    header.setAttribute('aria-expanded', 'false');
                    chevron.style.transform = 'rotate(0deg)';
                }
            }

            // Global toggle binding (works even if chart renders later)
            (function setupSizeChartToggle(){
                document.addEventListener('click', (e) => {
                    const header = e.target.closest('#sizeChartHeader');
                    if (!header) return;
                    const container = document.getElementById('sizeChartContainer');
                    const content = document.getElementById('sizeChartContent');
                    const wrap = document.getElementById('sizeChartTableWrap');
                    const chevron = document.getElementById('sizeChartChevron');
                    if (!container || !content || !wrap || !chevron) return;
                    if (container.style.display === 'none') return; // no chart
                    const expanded = header.getAttribute('aria-expanded') === 'true';
                    if (expanded) {
                        header.setAttribute('aria-expanded', 'false');
                        chevron.style.transform = 'rotate(0deg)';
                        content.style.maxHeight = '0px';
                        content.style.opacity = '0';
                    } else {
                        header.setAttribute('aria-expanded', 'true');
                        chevron.style.transform = 'rotate(180deg)';
                        // Recalculate height on each toggle
                        const h = wrap.scrollHeight + 16;
                        content.style.maxHeight = h + 'px';
                        content.style.opacity = '1';
                    }
                });
            })();

            addBtn.addEventListener('click', () => {
                const product = window.pdState.product;
                const variant = window.pdState.selectedVariant;
                if (!product || !variant) return;
                if (!window.shoppingCart) return;
                window.shoppingCart.addToCart(product.id, variant.id, 1, product, variant);
            });

            // 1) Try sessionStorage hydration for instant render
            let snapshot = null;
            try {
                if (slugParam && sessionStorage.getItem(`pd:slug:${slugParam}`)) {
                    snapshot = JSON.parse(sessionStorage.getItem(`pd:slug:${slugParam}`));
                } else if (skuParam && sessionStorage.getItem(`pd:sku:${skuParam}`)) {
                    snapshot = JSON.parse(sessionStorage.getItem(`pd:sku:${skuParam}`));
                } else if (productId && sessionStorage.getItem(`pd:id:${productId}`)) {
                    snapshot = JSON.parse(sessionStorage.getItem(`pd:id:${productId}`));
                } else if (sessionStorage.getItem('pd:last')) {
                    snapshot = JSON.parse(sessionStorage.getItem('pd:last'));
                }
            } catch (e) {}

            if (snapshot?.product) {
                const product = snapshot.product;
                window.pdState.product = product;
                window.pdState.variants = product.variants || [];
                setName(product.name);
                setCategory(product.category || product.type || product.collection || 'Product');
                setDesc(product.description || product.details || '');
                setImage(pdImageUrl(product.images?.[0]), product.name || '');
                window.pdState.selectedImageIndex = 0;
                renderThumbGrid(product);
                wireThumbEvents(product);
                // Initial selection & UI
                wireSwatchEvents(product);

                // Preselect by sku/id if possible
                let initialVariant = null;
                if (skuParam) {
                    initialVariant = (product.variants || []).find(v => (v.sku || v.variantSku || v.id) === skuParam) || null;
                }
                if (!initialVariant && snapshot.selectedVariantId) {
                    initialVariant = (product.variants || []).find(v => v.id === snapshot.selectedVariantId) || null;
                }
                if (!initialVariant) initialVariant = (product.variants || [])[0] || null;

                if (initialVariant) {
                    window.pdState.selectedSize = initialVariant.size || null;
                    window.pdState.selectedColor = initialVariant.color || null;
                }
                const __sizesForInitialColor = availableSizes(product, window.pdState.selectedColor || null);
                if (__sizesForInitialColor.length === 0) {
                    window.pdState.selectedSize = null;
                    window.pdState.selectedVariant = null;
                }
                renderColorSwatches(product);
                renderSizeSwatches(product);
                const __effVariant = window.pdState.selectedSize ? findVariant(product, window.pdState.selectedSize, window.pdState.selectedColor) : null;
                applyVariant(__effVariant);
                updateAddButtonState(product);
                if (addBtn) { addBtn.textContent = addBtn.disabled ? 'Sold out' : 'Add to cart'; }
                renderSizeChart(product);
            }

            // 2) Optional: refresh from Firestore if we have explicit product id or slug
            if ((productId || slugParam) && window.firebaseServices && window.firebaseServices.db) {
                try {
                    const db = window.firebaseServices.db;
                    let product = null;
                    if (productId) {
                        const doc = await db.collection('products').doc(productId).get();
                        if (doc.exists) { product = { id: productId, ...(doc.data() || {}) }; }
                    } else if (slugParam) {
                        const q = await db.collection('products').where('slug', '==', slugParam).limit(1).get();
                        if (!q.empty) {
                            const d = q.docs[0];
                            product = { id: d.id, ...(d.data() || {}) };
                        }
                    }
                    if (product) {
                        const variantsSnap = await db.collection('products').doc(product.id).collection('variants').get();
                        product.variants = variantsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                        window.pdState.product = product;
                        window.pdState.variants = product.variants || [];
                        setName(product.name);
                        setCategory(product.category || product.type || product.collection || 'Product');
                        setDesc(product.description || product.details || '');
                        setImage(pdImageUrl(product.images?.[0]), product.name || '');
                        window.pdState.selectedImageIndex = 0;
                        renderThumbGrid(product);
                        wireThumbEvents(product);
                        wireSwatchEvents(product);
                        renderColorSwatches(product);
                        renderSizeSwatches(product);

                        const size = window.pdState.selectedSize || product.variants?.[0]?.size || '';
                        const color = window.pdState.selectedColor || product.variants?.[0]?.color || '';
                        const refreshed = findVariant(product, size, color);
                        applyVariant(refreshed);
                        updateAddButtonState(product);
                        if (addBtn) { addBtn.textContent = addBtn.disabled ? 'Sold out' : 'Add to cart'; }
                        renderSizeChart(product);

                        // Persist snapshot for speed on future navigations
                        try {
                            const selectedSku = (refreshed && (refreshed.sku || refreshed.variantSku || refreshed.id)) || null;
                            const snap = { product, selectedVariantId: refreshed?.id || null, selectedSku, savedAt: Date.now() };
                            if (product.id) sessionStorage.setItem(`pd:id:${product.id}`, JSON.stringify(snap));
                            if (product.slug) sessionStorage.setItem(`pd:slug:${product.slug}`, JSON.stringify(snap));
                            sessionStorage.setItem('pd:last', JSON.stringify(snap));
                            if (selectedSku) sessionStorage.setItem(`pd:sku:${selectedSku}`, JSON.stringify(snap));
                        } catch (e) {}
                    }
                } catch (e) {
                    // ignore
                }
            }
        });
    </script>
</body>
</html> 