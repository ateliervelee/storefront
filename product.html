<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product • Atelier Veleé</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=5">
</head>
<body>
    <!-- Shared Header Placeholder -->
    <header-placeholder></header-placeholder>

    <!-- Product Detail Content -->
    <main style="max-width: 1200px; margin: 0 auto; padding: 6rem 2rem 3rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: start;">
            <div>
                <div style="width: 100%; aspect-ratio: 3/4; background: var(--light-grey, #f5f5f5); border-radius: 12px; overflow: hidden;">
                    <img id="pdMainImage" src="" alt="" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </div>
            <div>
                <h1 id="productName" style="font-family: 'Playfair Display', serif; font-size: 2.25rem; color: var(--charcoal, #2b2b2b); margin: 0 0 0.5rem 0;">Loading…</h1>
                <div id="productPrice" style="font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto; font-size: 1.25rem; color: var(--charcoal, #2b2b2b); margin-bottom: 1.25rem;">—</div>

                <div style="display: grid; gap: 1rem; max-width: 420px;">
                    <label style="display: grid; gap: 0.25rem;">
                        <span style="font-size: 0.9rem; color: var(--deep-taupe, #756d6a);">Size</span>
                        <select id="sizeSelect" style="padding: 0.75rem 0.9rem; border: 1px solid var(--soft-beige, #e7e1db); border-radius: 8px; background: #fff; font-family: 'Inter', system-ui;">
                            <option value="">Select size</option>
                        </select>
                    </label>

                    <label style="display: grid; gap: 0.25rem;">
                        <span style="font-size: 0.9rem; color: var(--deep-taupe, #756d6a);">Color</span>
                        <select id="colorSelect" style="padding: 0.75rem 0.9rem; border: 1px solid var(--soft-beige, #e7e1db); border-radius: 8px; background: #fff; font-family: 'Inter', system-ui;">
                            <option value="">Select color</option>
                        </select>
                    </label>

                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <button id="addToCartBtn" style="flex: 1; padding: 0.9rem 1.1rem; border: none; border-radius: 10px; background: var(--charcoal, #2b2b2b); color: #fff; font-weight: 600; cursor: pointer;">Add to cart</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Shared Footer Placeholder -->
    <footer-placeholder></footer-placeholder>

    <!-- Script Loader (injects script.js, cart.js, etc.) -->
    <script src="main.js"></script>
    <script>
        // Simple helpers (scoped to this page)
        function pdFormatPrice(price, currency = 'EUR') {
            if (typeof price !== 'number') return '—';
            const euros = Math.floor(price / 100);
            const cents = price % 100;
            if (currency === 'EUR') return `€${euros}.${cents.toString().padStart(2, '0')}`;
            return `${currency} ${euros}.${cents.toString().padStart(2, '0')}`;
        }
        function pdImageUrl(name) {
            if (!name) return '';
            if (name.startsWith('http')) return name;
            return `assets/images/${name}`;
        }
        function unique(list) { return Array.from(new Set(list)); }

        // In-memory page state
        window.pdState = { product: null, variants: [], selectedVariant: null };

        document.addEventListener('allScriptsLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');
            const skuParam = params.get('sku');

            const nameEl = document.getElementById('productName');
            const priceEl = document.getElementById('productPrice');
            const imgEl = document.getElementById('pdMainImage');
            const sizeSelect = document.getElementById('sizeSelect');
            const colorSelect = document.getElementById('colorSelect');
            const addBtn = document.getElementById('addToCartBtn');

            const setName = (n) => { if (nameEl) nameEl.textContent = n || 'Product'; };
            const setPrice = (p, c) => { if (priceEl) priceEl.textContent = pdFormatPrice(p, c || 'EUR'); };
            const setImage = (src, alt) => { if (imgEl) { imgEl.src = src || ''; imgEl.alt = alt || ''; } };

            function applyVariant(variant) {
                if (!variant) return;
                window.pdState.selectedVariant = variant;
                setPrice(variant.price, variant.currency);
            }

            function populateSelectors(product) {
                const sizes = unique((product.variants || []).map(v => v.size).filter(Boolean)).sort((a,b) => {
                    const order = ['XS','S','M','L','XL','XXL'];
                    return order.indexOf(a) - order.indexOf(b);
                });
                const colors = unique((product.variants || []).map(v => v.color).filter(Boolean));

                sizeSelect.innerHTML = '<option value="">Select size</option>' + sizes.map(s => `<option value="${s}">${s}</option>`).join('');
                colorSelect.innerHTML = '<option value="">Select color</option>' + colors.map(c => `<option value="${c}">${c}</option>`).join('');
            }

            function findVariant(product, size, color) {
                if (!product?.variants) return null;
                // Prefer exact size+color match, else first by size, else first
                return product.variants.find(v => v.size === size && v.color === color) ||
                       product.variants.find(v => v.size === size) ||
                       product.variants[0] || null;
            }

            function updateFromSelectors() {
                const size = sizeSelect.value || null;
                const color = colorSelect.value || null;
                const variant = findVariant(window.pdState.product, size, color);
                applyVariant(variant);
            }

            addBtn.addEventListener('click', () => {
                const product = window.pdState.product;
                const variant = window.pdState.selectedVariant;
                if (!product || !variant) return;
                if (!window.shoppingCart) return;
                window.shoppingCart.addToCart(product.id, variant.id, 1, product, variant);
            });

            sizeSelect.addEventListener('change', updateFromSelectors);
            colorSelect.addEventListener('change', updateFromSelectors);

            // 1) Try sessionStorage hydration for instant render
            let snapshot = null;
            try {
                if (skuParam && sessionStorage.getItem(`pd:sku:${skuParam}`)) {
                    snapshot = JSON.parse(sessionStorage.getItem(`pd:sku:${skuParam}`));
                } else if (productId && sessionStorage.getItem(`pd:id:${productId}`)) {
                    snapshot = JSON.parse(sessionStorage.getItem(`pd:id:${productId}`));
                } else if (sessionStorage.getItem('pd:last')) {
                    snapshot = JSON.parse(sessionStorage.getItem('pd:last'));
                }
            } catch (e) {}

            if (snapshot?.product) {
                const product = snapshot.product;
                window.pdState.product = product;
                window.pdState.variants = product.variants || [];
                setName(product.name);
                setImage(pdImageUrl(product.images?.[0]), product.name || '');
                populateSelectors(product);

                // Preselect by sku/id if possible
                let initialVariant = null;
                if (skuParam) {
                    initialVariant = (product.variants || []).find(v => (v.sku || v.variantSku || v.id) === skuParam) || null;
                }
                if (!initialVariant && snapshot.selectedVariantId) {
                    initialVariant = (product.variants || []).find(v => v.id === snapshot.selectedVariantId) || null;
                }
                if (!initialVariant) initialVariant = (product.variants || [])[0] || null;

                // Set selectors to match initial variant
                if (initialVariant) {
                    if (initialVariant.size) sizeSelect.value = initialVariant.size;
                    if (initialVariant.color) colorSelect.value = initialVariant.color;
                }
                applyVariant(initialVariant);
            }

            // 2) Optional: refresh from Firestore if we have an explicit product id
            if (productId && window.firebaseServices && window.firebaseServices.db) {
                try {
                    const db = window.firebaseServices.db;
                    const doc = await db.collection('products').doc(productId).get();
                    if (doc.exists) {
                        const data = doc.data() || {};
                        const product = { id: productId, ...data };

                        // Fetch variants subcollection
                        const variantsSnap = await db.collection('products').doc(productId).collection('variants').get();
                        product.variants = variantsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                        window.pdState.product = product;
                        window.pdState.variants = product.variants || [];
                        setName(product.name);
                        setImage(pdImageUrl(product.images?.[0]), product.name || '');
                        populateSelectors(product);

                        // Choose best initial variant again (respect current selections)
                        const size = sizeSelect.value || product.variants?.[0]?.size || '';
                        const color = colorSelect.value || product.variants?.[0]?.color || '';
                        const refreshed = findVariant(product, size, color);
                        applyVariant(refreshed);

                        // Persist snapshot for speed on future navigations
                        try {
                            const selectedSku = (refreshed && (refreshed.sku || refreshed.variantSku || refreshed.id)) || null;
                            const snap = { product, selectedVariantId: refreshed?.id || null, selectedSku, savedAt: Date.now() };
                            sessionStorage.setItem(`pd:id:${productId}`, JSON.stringify(snap));
                            sessionStorage.setItem('pd:last', JSON.stringify(snap));
                            if (selectedSku) sessionStorage.setItem(`pd:sku:${selectedSku}`, JSON.stringify(snap));
                        } catch (e) {}
                    }
                } catch (e) {
                    // ignore
                }
            }
        });
    </script>
</body>
</html> 